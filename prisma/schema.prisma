// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  password  String
  name      String
  role      String   // SUPERVISOR, TEACHER, STUDENT
  createdAt DateTime @default(now())
  
  // Relations
  teacherHalaqas Halaqa[] @relation("TeacherHalaqas")
  assistantHalaqas Halaqa[] @relation("AssistantTeachers")
  notifications Notification[]
  participatingEvents QuranicEvent[] @relation("EventTeachers")
  eventAssignments    EventAssignment[]
}

model Halaqa {
  id        Int      @id @default(autoincrement())
  name      String
  teacherId Int?
  teacher   User?    @relation("TeacherHalaqas", fields: [teacherId], references: [id])
  assistants User[]  @relation("AssistantTeachers")
  students  Student[]
  createdAt DateTime @default(now())
}

model Student {
  id           Int      @id @default(autoincrement())
  name         String
  username     String   @unique
  password     String
  hifzProgress String?   // Current surah name
  currentHifzSurahId Int? @default(114) // 1-114
  juzCount     Int      @default(0)
  reviewPlan   String?
  dailyTargetPages Float? @default(1.0) // Goal in pages (can be 0.5)
  createdAt    DateTime @default(now())
  
  halaqaId     Int?
  halaqa       Halaqa?  @relation(fields: [halaqaId], references: [id])
  
  attendance   Attendance[]
  sessions     Session[]
  notifications Notification[]
  eventAssignments EventAssignment[]
  exams        Exam[]
}

model Attendance {
  id        Int      @id @default(autoincrement())
  studentId Int
  student   Student  @relation(fields: [studentId], references: [id])
  date      DateTime @default(now())
  status    String   // PRESENT, ABSENT_EXCUSED, ABSENT_UNEXCUSED
}

model Session {
  id           Int      @id @default(autoincrement())
  studentId    Int
  student      Student  @relation(fields: [studentId], references: [id])
  date         DateTime @default(now())
  
  // Hifz
  hifzSurah    String?
  hifzFromPage Int?
  hifzToPage   Int?
  hifzFromAyah Int?
  hifzToAyah   Int?
  
  // Murajaah
  murajaahFromSurah String?
  murajaahFromAyah  Int?
  murajaahToSurah   String?
  murajaahToAyah    Int?
  
  pagesCount   Float?   // Total pages calculated
  resultString String?  // e.g. "جزء و 5 صفحات و 10 آيات"
  notes        String?
  
  // Quality Metrics - General or Murajaah (backward compatible)
  errorsCount      Int @default(0)  // عدد الأخطاء (أصبح للمراجعة أو الإجمالي)
  alertsCount      Int @default(0)  // عدد التنبيهات (أصبح للمراجعة أو الإجمالي)
  cleanPagesCount  Int @default(0)  // الصفحات النقية
  
  // Quality Metrics - Hifz Specific
  hifzErrors       Int @default(0)  // أخطاء الحفظ
  hifzAlerts       Int @default(0)  // تنبيهات الحفظ
  hifzCleanPages   Int @default(0)  // الصفحات النقية في الحفظ
  
  isGoalAchieved   Boolean @default(false) // هل حقق الهدف اليومي؟

  // Quranic Days Relation
  quranicEventId Int?
  quranicEvent   QuranicEvent? @relation(fields: [quranicEventId], references: [id])
}

model QuranicEvent {
  id          Int       @id @default(autoincrement())
  name        String
  startDate   DateTime
  endDate     DateTime
  isActive    Boolean   @default(false)
  sessions    Session[]
  teachers    User[]    @relation("EventTeachers")
  assignments EventAssignment[]
  createdAt   DateTime  @default(now())
}

model EventAssignment {
  id        Int      @id @default(autoincrement())
  eventId   Int
  teacherId Int
  studentId Int
  
  event     QuranicEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  teacher   User         @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  student   Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([eventId, teacherId, studentId])
}

// Notification types: WARNING (Red), INFO (Blue), PROPOSAL (Green)
model Notification {
  id             Int      @id @default(autoincrement())
  title          String   @default("إشعار جديد")
  message        String   // Content
  type           String   @default("INFO") // WARNING, INFO, PROPOSAL
  isRead         Boolean  @default(false)
  createdAt      DateTime @default(now())
  
  attachmentUrl  String?
  attachmentType String?  // IMAGE, VIDEO, LINK
  
  // Recipient (Can be User or Student)
  userId         Int?
  user           User?    @relation(fields: [userId], references: [id])
  
  studentId      Int?
  student        Student? @relation(fields: [studentId], references: [id])
  
  // Sender info (Optional)
  senderId       Int?
  senderRole     String?  // SUPERVISOR, TEACHER
}

model Exam {
  id          Int      @id @default(autoincrement())
  studentId   Int
  student     Student  @relation(fields: [studentId], references: [id])
  stationId   Int?     // 1 to 11
  stationName String   // "الفرع الأول: جزء واحد"
  status      String   // PENDING, SCHEDULED, COMPLETED, CANCELLED
  examDate    DateTime?
  examTime    String?  // "بعد صلاة المغرب", etc.
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  grade       Float?   // Optional: result
  notes       String?
}
